/*
* Kendo UI Complete v2013.3.1316 (http://kendoui.com)
* Copyright 2014 Telerik AD. All rights reserved.
*
* Kendo UI Complete commercial licenses may be obtained at
* https://www.kendoui.com/purchase/license-agreement/kendo-ui-complete-commercial.aspx
* If you do not own a commercial license, this file shall be governed by the trial license terms.
*/
!function(define){return define(["./kendo.diagram.math.min"],function(){!function(){var t=window.kendo,e=t.diagram,i=e.Graph,n=e.Node,r=e.Link,a=t.deepExtend,s=e.Size,o=e.Rect,h=e.Dictionary,l=e.Set,d=e.Graph,g=e.Utils,u=e.Point,c=t.Class.extend({defaultOptions:null,init:function(){this.defaultOptions={roots:null,animate:!1,limitToView:!1,friction:.9,nodeDistance:50,iterations:300,treeLayoutType:t.diagram.TreeLayoutType.TreeDown,horizontalSeparation:90,verticalSeparation:50,underneathVerticalTopOffset:15,underneathHorizontalOffset:15,underneathVerticalSeparation:15,componentsGridWidth:1500,totalMargin:new s(50,50),componentMargin:new s(20,20),layerSeparation:50,layeredLayoutType:t.diagram.LayeredLayoutType.Right,layeredIterations:2,startRadialAngle:0,endRadialAngle:2*Math.PI,radialSeparation:150,radialFirstLevelSeparation:200,keepComponentsInOneRadialLayout:!1,ignoreContainers:!0,layoutContainerChildren:!1,ignoreInvisible:!0,animateTransitions:!1}},gridLayoutComponents:function(t){var e,i,n,r,a,s,o,h,l,d,g,c,p,f,y;if(!t)throw"No components supplied.";for(t.forEach(function(t){t.calcBounds()}),t.sort(function(t,e){return e.bounds.width-t.bounds.width}),i=this.options.componentsGridWidth,n=this.options.componentMargin.width,r=this.options.componentMargin.height,a=0,s=this.options.totalMargin.width,o=this.options.totalMargin.height,h=s,l=o,d=[],g=[];t.length>0;){for(h>=i&&(h=s,l+=a+r,a=0),c=t.pop(),this.moveToOffset(c,new u(h,l)),e=0;e<c.nodes.length;e++)g.push(c.nodes[e]);for(e=0;e<c.links.length;e++)d.push(c.links[e]);p=c.bounds,f=p.height,(0>=f||isNaN(f))&&(f=0),y=p.width,(0>=y||isNaN(y))&&(y=0),f>=a&&(a=f),h+=y+n}return{nodes:g,links:d}},moveToOffset:function(t,e){var i,n,r,a,s,h,l,d,g=t.bounds,c=e.x-g.x,p=e.y-g.y;for(i=0;i<t.nodes.length;i++)r=t.nodes[i],a=r.bounds(),0===a.width&&0===a.height&&0===a.x&&0===a.y&&(a=new o(0,0,0,0)),a.x+=c,a.y+=p,r.bounds(a);for(i=0;i<t.links.length;i++)if(s=t.links[i],s.points){for(h=[],l=s.points,n=0;n<l.length;n++)d=l[n],d.x+=c,d.y+=p,h.push(d);s.points=h}return this.currentHorizontalOffset+=g.width+this.options.totalMargin.width,new u(c,p)},transferOptions:function(e){this.options=this.defaultOptions,g.isUndefined(e)||(e&&(e.totalMargin&&(this.options.totalMargin=e.totalMargin,delete e.totalMargin),e.componentMargin&&(this.options.componentMargin=e.componentMargin,delete e.componentMargin)),this.options=t.deepExtend(this.options,e||{}))}}),p=t.Class.extend({init:function(t){this.nodeMap=new h,this.shapeMap=new h,this.nodes=[],this.edges=[],this.edgeMap=new h,this.finalNodes=[],this.finalLinks=[],this.ignoredConnections=[],this.ignoredShapes=[],this.hyperMap=new h,this.hyperTree=new i,this.finalGraph=null,this.diagram=t},convert:function(e){if(g.isUndefined(this.diagram))throw"No diagram to convert.";return this.options=t.deepExtend({ignoreInvisible:!0,ignoreContainers:!0,layoutContainerChildren:!1},e||{}),this.clear(),this._renormalizeShapes(),this._renormalizeConnections(),this.finalNodes=new h(this.nodes),this.finalLinks=new h(this.edges),this.finalGraph=new i,this.finalNodes.forEach(function(t){this.finalGraph.addNode(t)},this),this.finalLinks.forEach(function(t){this.finalGraph.addExistingLink(t)},this),this.finalGraph},mapConnection:function(t){return this.edgeMap.first(function(e){return this.edgeMap.get(e).contains(t)})},mapShape:function(t){var e,i,n,r=this.nodeMap.keys();for(e=0,i=r.length;i>e;e++)if(n=r[e],this.nodeMap.get(n).contains(t))return n},getEdge:function(t,e){return t.links.first(function(i){return i.getComplement(t)===e})},clear:function(){this.finalGraph=null,this.hyperTree=!this.options.ignoreContainers&&this.options.layoutContainerChildren?new d:null,this.hyperMap=!this.options.ignoreContainers&&this.options.layoutContainerChildren?new h:null,this.nodeMap=new h,this.shapeMap=new h,this.nodes=[],this.edges=[],this.edgeMap=new h,this.ignoredConnections=[],this.ignoredShapes=[],this.finalNodes=[],this.finalLinks=[]},listToRoot:function(t){var e=[],i=t.container;if(!i)return e;for(e.add(i);i.parentContainer;)i=i.parentContainer,e.add(i);return e.reverse(),e},firstNonIgnorableContainer:function(t){return t.isContainer&&!this._isIgnorableItem(t)?t:t.parentContainer?this.firstNonIgnorableContainer(t.parentContainer):null},isContainerConnection:function(t,e){return t.isContainer&&this.isDescendantOf(t,e)?!0:e.isContainer&&this.isDescendantOf(e,t)},isDescendantOf:function(t,e){var i,n,r,a;if(!t.isContainer)throw"Expecting a container.";if(t===e)return!1;if(t.children.contains(e))return!0;for(i=[],n=0,r=t.children.length;r>n;n++)a=t.children[n],a.isContainer&&this.isDescendantOf(a,e)&&i.push(a);return i.length>0},isIgnorableItem:function(t){return this.options.ignoreInvisible?t.isCollapsed&&this._isVisible(t)?!1:!t.isCollapsed&&this._isVisible(t)?!1:!0:t.isCollapsed&&!this._isTop(t)},isShapeMapped:function(t){return t.isCollapsed&&!this._isVisible(t)&&!this._isTop(t)},leastCommonAncestor:function(t,e){var i,n,r,a,s,o;if(!t)throw"Parameter should not be null.";if(!e)throw"Parameter should not be null.";if(!this.hyperTree)throw"No hypertree available.";if(i=this.listToRoot(t),n=this.listToRoot(e),r=null,i.isEmpty()||n.isEmpty())return this.hyperTree.root.data;for(a=i[0],s=n[0],o=0;a===s&&(r=i[o],o++,!(o>=i.length||o>=n.length));)a=i[o],s=n[o];return r?this.hyperTree.nodes.where(function(t){return t.data.container===r}):this.hyperTree.root.data},_isTop:function(t){return!t.parentContainer},_isVisible:function(t){return t.visible()?t.parentContainer?this._isVisible(t.parentContainer):t.visible():!1},_isCollapsed:function(t){return t.isContainer&&t.isCollapsed?!0:t.parentContainer&&this._isCollapsed(t.parentContainer)},_renormalizeShapes:function(){var t,e,i,r;if(!this.options.ignoreContainers)throw"Containers are not supported yet, but stay tuned.";for(t=0,e=this.diagram.shapes.length;e>t;t++)i=this.diagram.shapes[t],this.options.ignoreInvisible&&!this._isVisible(i)||i.isContainer?this.ignoredShapes.add(i):(r=new n(i.id,i),r.isVirtual=!1,this.nodeMap.add(r,[i]),this.nodes.add(r))},_renormalizeConnections:function(){var t,e,i,n,a,s,o,h;if(0!==this.diagram.connections.length)for(t=0,e=this.diagram.connections.length;e>t;t++)if(i=this.diagram.connections[t],this.isIgnorableItem(i))this.ignoredConnections.add(i);else if(n=i.sourceConnector?i.sourceConnector.shape:null,a=i.targetConnector?i.targetConnector.shape:null,n&&a)if(!this.ignoredShapes.contains(n)||this.shapeMap.containsKey(n))if(!this.ignoredShapes.contains(a)||this.shapeMap.containsKey(a))if(this.shapeMap.containsKey(n)&&(n=this.shapeMap[n]),this.shapeMap.containsKey(a)&&(a=this.shapeMap[a]),s=this.mapShape(n),o=this.mapShape(a),s===o||this.areConnectedAlready(s,o))this.ignoredConnections.add(i);else{if(null===s||null===o)throw"A shape was not mapped to a node.";if(!this.options.ignoreContainers)throw"Containers are not supported yet, but stay tuned.";s.isVirtual||o.isVirtual?this.ignoredConnections.add(i):(h=new r(s,o,i.id,i),this.edgeMap.add(h,[i]),this.edges.add(h))}else this.ignoredConnections.add(i);else this.ignoredConnections.add(i);else this.ignoredConnections.add(i)},areConnectedAlready:function(t,e){return this.edges.any(function(i){return i.source===t&&i.target===e||i.source===e&&i.target===t})}}),f=c.extend({init:function(t){var e=this;if(c.fn.init.call(e),g.isUndefined(t))throw"Diagram is not specified.";this.diagram=t},layout:function(e){var i,n,r,a,s,o;if(this.transferOptions(e),i=new p(this.diagram),n=i.convert(e),!n.isEmpty()&&(r=n.getConnectedComponents(),!r.isEmpty())){for(a=0;a<r.length;a++)s=r[a],this.layoutGraph(s,e);return o=this.gridLayoutComponents(r),new t.diagram.LayoutState(this.diagram,o)}},layoutGraph:function(t,e){var i,n,r;for(g.isDefined(e)&&this.transferOptions(e),this.graph=t,i=9*this.options.nodeDistance,this.temperature=i,n=this._expectedBounds(),this.width=n.width,this.height=n.height,r=0;r<this.options.iterations;r++)this.refineStage=r>=5*this.options.iterations/6,this.tick(),this.temperature=this.refineStage?i/30:i*(1-r/(2*this.options.iterations))},tick:function(){var t,e,i;for(t=0;t<this.graph.nodes.length;t++)this._repulsion(this.graph.nodes[t]);for(t=0;t<this.graph.links.length;t++)this._attraction(this.graph.links[t]);for(t=0;t<this.graph.nodes.length;t++){if(e=this.graph.nodes[t],i=Math.sqrt(e.dx*e.dx+e.dy*e.dy),0===i)return;e.x+=Math.min(i,this.temperature)*e.dx/i,e.y+=Math.min(i,this.temperature)*e.dy/i,this.options.limitToView&&(e.x=Math.min(this.width,Math.max(e.width/2,e.x)),e.y=Math.min(this.height,Math.max(e.height/2,e.y)))}},_shake:function(t){var e=Math.random()*this.options.nodeDistance/4,i=2*Math.random()*Math.PI;t.x+=e*Math.cos(i),t.y-=e*Math.sin(i)},_InverseSquareForce:function(t,e,i){var n,r,a,s,o,h,l;return this.refineStage?(r=e.x-i.x,a=e.y-i.y,s=e.width/2,o=e.height/2,h=i.width/2,l=i.height/2,n=Math.pow(r,2)/Math.pow(s+h+this.options.nodeDistance,2)+Math.pow(a,2)/Math.pow(o+l+this.options.nodeDistance,2)):n=Math.pow(t,2)/Math.pow(this.options.nodeDistance,2),4*n/3},_SquareForce:function(t,e,i){return 1/this._InverseSquareForce(t,e,i)},_repulsion:function(t){t.dx=0,t.dy=0,this.graph.nodes.forEach(function(e){var i,n,r,a;if(e!==t){for(;t.x===e.x&&t.y===e.y;)this._shake(e);i=t.x-e.x,n=t.y-e.y,r=Math.sqrt(i*i+n*n),a=2*this._SquareForce(r,t,e),t.dx+=i/r*a,t.dy+=n/r*a}},this)},_attraction:function(t){var e,i,n,r,a,s,o=t.target,h=t.source;if(h!==o){for(;h.x===o.x&&h.y===o.y;)this._shake(o);e=h.x-o.x,i=h.y-o.y,n=Math.sqrt(e*e+i*i),r=5*this._InverseSquareForce(n,h,o),a=e/n*r,s=i/n*r,o.dx+=a,o.dy+=s,h.dx-=a,h.dy-=s}},_expectedBounds:function(){var t,e,i,n,r,a=this.graph.nodes.length,s=1.5,o=4;return 0===a?t:(t=this.graph.nodes.fold(function(t,e){var i=e.width*e.height;return i>0?t+=Math.sqrt(i):0},0,this),e=t/a,i=e*Math.ceil(Math.sqrt(a)),n=i*Math.sqrt(s),r=i/Math.sqrt(s),{width:n*o,height:r*o})}}),y=t.Class.extend({init:function(t){this.center=null,this.options=t},layout:function(t,e){if(this.graph=t,this.graph.nodes&&0!==this.graph.nodes.length){if(!this.graph.nodes.contains(e))throw"The given root is not in the graph.";this.center=e,this.graph.cacheRelationships(),this.layoutSwitch()}},layoutLeft:function(e){var i,n,r,a,o,h,l,d;for(this.setChildrenDirection(this.center,t.diagram.TreeDirection.Left,!1),this.setChildrenLayout(this.center,t.diagram.ChildrenLayout.Default,!1),a=0,o=0,n=0;n<e.length;n++)r=e[n],r.TreeDirection=t.diagram.TreeDirection.Left,h=this.measure(r,s.Empty),o=Math.max(o,h.Width),a+=h.height+this.options.verticalSeparation;for(a-=this.options.verticalSeparation,l=this.center.x-this.options.horizontalSeparation,i=this.center.y+(this.center.height-a)/2,n=0;n<e.length;n++)r=e[n],d=new u(l-r.Size.width,i),this.arrange(r,d),i+=r.Size.height+this.options.verticalSeparation},layoutRight:function(e){var i,n,r,a,o,h,l,d;for(this.setChildrenDirection(this.center,t.diagram.TreeDirection.Right,!1),this.setChildrenLayout(this.center,t.diagram.ChildrenLayout.Default,!1),a=0,o=0,n=0;n<e.length;n++)r=e[n],r.TreeDirection=t.diagram.TreeDirection.Right,h=this.measure(r,s.Empty),o=Math.max(o,h.Width),a+=h.height+this.options.verticalSeparation;for(a-=this.options.verticalSeparation,l=this.center.x+this.options.horizontalSeparation+this.center.width,i=this.center.y+(this.center.height-a)/2,n=0;n<e.length;n++)r=e[n],d=new u(l,i),this.arrange(r,d),i+=r.Size.height+this.options.verticalSeparation},layoutUp:function(e){var i,n,r,a,o,h,l;for(this.setChildrenDirection(this.center,t.diagram.TreeDirection.Up,!1),this.setChildrenLayout(this.center,t.diagram.ChildrenLayout.Default,!1),a=0,r=0;r<e.length;r++)n=e[r],n.TreeDirection=t.diagram.TreeDirection.Up,o=this.measure(n,s.Empty),a+=o.width+this.options.horizontalSeparation;for(a-=this.options.horizontalSeparation,h=this.center.x+this.center.width/2-a/2,r=0;r<e.length;r++)n=e[r],i=this.center.y-this.options.verticalSeparation-n.Size.height,l=new u(h,i),this.arrange(n,l),h+=n.Size.width+this.options.horizontalSeparation},layoutDown:function(e){var i,n,r,a,o,h,l;for(this.setChildrenDirection(this.center,t.diagram.TreeDirection.Down,!1),this.setChildrenLayout(this.center,t.diagram.ChildrenLayout.Default,!1),a=0,n=0;n<e.length;n++)i=e[n],i.treeDirection=t.diagram.TreeDirection.Down,o=this.measure(i,s.Empty),a+=o.width+this.options.horizontalSeparation;for(a-=this.options.horizontalSeparation,h=this.center.x+this.center.width/2-a/2,r=this.center.y+this.options.verticalSeparation+this.center.height,n=0;n<e.length;n++)i=e[n],l=new u(h,r),this.arrange(i,l),h+=i.Size.width+this.options.horizontalSeparation},layoutRadialTree:function(){var e,i;if(this.setChildrenDirection(this.center,t.diagram.TreeDirection.Radial,!1),this.setChildrenLayout(this.center,t.diagram.ChildrenLayout.Default,!1),this.previousRoot=null,e=this.options.startRadialAngle,i=this.options.endRadialAngle,e>=i)throw"Final angle should not be less than the start angle.";this.maxDepth=0,this.origin=new u(this.center.x,this.center.y),this.calculateAngularWidth(this.center,0),this.maxDepth>0&&this.radialLayout(this.center,this.options.radialFirstLevelSeparation,e,i),this.center.Angle=i-e},tipOverTree:function(e,i){var n,r,a,o,h,l,d;for(g.isUndefined(i)&&(i=0),this.setChildrenDirection(this.center,t.diagram.TreeDirection.Down,!1),this.setChildrenLayout(this.center,t.diagram.ChildrenLayout.Default,!1),this.setChildrenLayout(this.center,t.diagram.ChildrenLayout.Underneath,!1,i),o=0,a=0;a<e.length;a++)r=e[a],r.TreeDirection=t.diagram.TreeDirection.Down,h=this.measure(r,s.Empty),o+=h.width+this.options.horizontalSeparation;for(o-=this.options.horizontalSeparation,o-=e[e.length-1].width,o+=e[e.length-1].associatedShape.bounds().width,l=this.center.x+this.center.width/2-o/2,n=this.center.y+this.options.verticalSeparation+this.center.height,a=0;a<e.length;a++)r=e[a],d=new u(l,n),this.arrange(r,d),l+=r.Size.width+this.options.horizontalSeparation},calculateAngularWidth:function(t,e){var i,n,r,a,s,o,h;if(e>this.maxDepth&&(this.maxDepth=e),i=0,n=1e3,r=1e3,a=0===e?0:Math.sqrt(n*n+r*r)/e,t.children.length>0){for(s=0,o=t.children.length;o>s;s++)h=t.children[s],i+=this.calculateAngularWidth(h,e+1);i=Math.max(a,i)}else i=a;return t.sectorAngle=i,i},sortChildren:function(t){var e,i,n,r,a,s,o,h,l,d,g,c=0;if(t.parents.length>1)throw"Node is not part of a tree.";if(i=t.parents[0],i&&(n=new u(i.x,i.y),r=new u(t.x,t.y),c=this.normalizeAngle(Math.atan2(n.y-r.y,n.x-r.x))),a=t.children.length,0===a)return null;for(s=[],o=[],e=0;a>e;++e)h=t.children[e],l=new u(h.x,h.y),o[e]=e,s[e]=this.normalizeAngle(-c+Math.atan2(l.y-l.y,l.x-l.x));for(Array.prototype.bisort(s,o),d=[],g=t.children,e=0;a>e;++e)d.add(g[o[e]]);return d},normalizeAngle:function(t){for(;t>2*Math.PI;)t-=2*Math.PI;for(;0>t;)t+=2*Math.PI;return t},radialLayout:function(t,e,i,n){var r,a,s,o,h,l=n-i,d=l/2,g=t.sectorAngle,u=0,c=this.sortChildren(t);for(r=0,a=c.length;a>r;r++)s=c[r],o=s,h=o.sectorAngle/g,s.children.length>0&&this.radialLayout(s,e+this.options.radialSeparation,i+u*l,i+(u+h)*l),this.setPolarLocation(s,e,i+u*l+h*d),o.angle=h*l,u+=h},setPolarLocation:function(t,e,i){t.x=this.origin.x+e*Math.cos(i),t.y=this.origin.y+e*Math.sin(i),t.BoundingRectangle=new o(t.x,t.y,t.width,t.height)},setChildrenDirection:function(t,e,i){var n=t.treeDirection;this.graph.depthFirstTraversal(t,function(t){t.treeDirection=e}),i||(t.treeDirection=n)},setChildrenLayout:function(t,e,i,n){g.isUndefined(n)&&(n=0);var r=t.childrenLayout;n>0?(this.graph.assignLevels(t),this.graph.depthFirstTraversal(t,function(t){t.level>=n+1&&(t.childrenLayout=e)})):(this.graph.depthFirstTraversal(t,function(t){t.childrenLayout=e}),i||(t.childrenLayout=r))},measure:function(e,i){var n,r,a,o,h,l,d,g=0,u=0,c=new s(0,0);if(!e)throw"";if(r=e.associatedShape.bounds(),a=r.width,o=r.height,1!==e.parents.length)throw"Node not in a spanning tree.";if(h=e.parents[0],e.treeDirection===t.diagram.TreeDirection.Undefined&&(e.treeDirection=h.treeDirection),e.children.isEmpty())c=new s(Math.abs(a)<Math.epsilon?50:a,Math.abs(o)<Math.epsilon?25:o);else if(1===e.children.length){switch(e.treeDirection){case t.diagram.TreeDirection.Radial:n=this.measure(e.children[0],i),g=a+this.options.radialSeparation*Math.cos(e.AngleToParent)+n.width,u=o+Math.abs(this.options.radialSeparation*Math.sin(e.AngleToParent))+n.height;break;case t.diagram.TreeDirection.Left:case t.diagram.TreeDirection.Right:switch(e.childrenLayout){case t.diagram.ChildrenLayout.TopAlignedWithParent:break;case t.diagram.ChildrenLayout.BottomAlignedWithParent:break;case t.diagram.ChildrenLayout.Underneath:n=this.measure(e.children[0],i),g=a+n.width+this.options.underneathHorizontalOffset,u=o+this.options.underneathVerticalTopOffset+n.height;break;case t.diagram.ChildrenLayout.Default:n=this.measure(e.children[0],i),g=a+this.options.horizontalSeparation+n.width,u=Math.max(o,n.height);break;default:throw"Unhandled TreeDirection in the Radial layout measuring."}break;case t.diagram.TreeDirection.Up:case t.diagram.TreeDirection.Down:switch(e.childrenLayout){case t.diagram.ChildrenLayout.TopAlignedWithParent:break;case t.diagram.ChildrenLayout.BottomAlignedWithParent:break;case t.diagram.ChildrenLayout.Underneath:n=this.measure(e.children[0],i),g=Math.max(a,n.width+this.options.underneathHorizontalOffset),u=o+this.options.underneathVerticalTopOffset+n.height;break;case t.diagram.ChildrenLayout.Default:n=this.measure(e.children[0],i),u=o+this.options.verticalSeparation+n.height,g=Math.max(a,n.width);break;default:throw"Unhandled TreeDirection in the Down layout measuring."}break;default:throw"Unhandled TreeDirection in the layout measuring."}c=new s(g,u)}else{switch(e.treeDirection){case t.diagram.TreeDirection.Left:case t.diagram.TreeDirection.Right:switch(e.childrenLayout){case t.diagram.ChildrenLayout.TopAlignedWithParent:break;case t.diagram.ChildrenLayout.BottomAlignedWithParent:break;case t.diagram.ChildrenLayout.Underneath:for(g=a,u=o+this.options.underneathVerticalTopOffset,l=0;l<e.children.length;l++)d=e.children[l],n=this.measure(d,i),g=Math.max(g,n.width+this.options.underneathHorizontalOffset),u+=n.height+this.options.underneathVerticalSeparation;u-=this.options.underneathVerticalSeparation;break;case t.diagram.ChildrenLayout.Default:for(g=a,u=0,l=0;l<e.children.length;l++)d=e.children[l],n=this.measure(d,i),g=Math.max(g,a+this.options.horizontalSeparation+n.width),u+=n.height+this.options.verticalSeparation;u-=this.options.verticalSeparation;break;default:throw"Unhandled TreeDirection in the Right layout measuring."}break;case t.diagram.TreeDirection.Up:case t.diagram.TreeDirection.Down:switch(e.childrenLayout){case t.diagram.ChildrenLayout.TopAlignedWithParent:break;case t.diagram.ChildrenLayout.BottomAlignedWithParent:break;case t.diagram.ChildrenLayout.Underneath:for(g=a,u=o+this.options.underneathVerticalTopOffset,l=0;l<e.children.length;l++)d=e.children[l],n=this.measure(d,i),g=Math.max(g,n.width+this.options.underneathHorizontalOffset),u+=n.height+this.options.underneathVerticalSeparation;u-=this.options.underneathVerticalSeparation;break;case t.diagram.ChildrenLayout.Default:for(g=0,u=0,l=0;l<e.children.length;l++)d=e.children[l],n=this.measure(d,i),g+=n.width+this.options.horizontalSeparation,u=Math.max(u,n.height+this.options.verticalSeparation+o);g-=this.options.horizontalSeparation;break;default:throw"Unhandled TreeDirection in the Down layout measuring."}break;default:throw"Unhandled TreeDirection in the layout measuring."}c=new s(g,u)}return e.SectorAngle=Math.sqrt(g*g/4+u*u/4),e.Size=c,c},arrange:function(e,i){var n,r,a,s,h,l,d,g,c=e.associatedShape.bounds(),p=c.width,f=c.height;if(e.children.isEmpty())e.x=i.x,e.y=i.y,e.BoundingRectangle=new o(i.x,i.y,p,f);else switch(e.treeDirection){case t.diagram.TreeDirection.Left:switch(e.childrenLayout){case t.diagram.ChildrenLayout.TopAlignedWithParent:break;case t.diagram.ChildrenLayout.BottomAlignedWithParent:break;case t.diagram.ChildrenLayout.Underneath:for(g=i,e.x=g.x,e.y=g.y,e.BoundingRectangle=new o(e.x,e.y,e.width,e.height),d=i.y+f+this.options.underneathVerticalTopOffset,n=0;n<s.children.length;n++)s=s.children[n],l=g.x-s.associatedShape.width-this.options.underneathHorizontalOffset,r=new u(l,d),this.arrange(s,r),d+=s.Size.height+this.options.underneathVerticalSeparation;break;case t.diagram.ChildrenLayout.Default:for(g=new u(i.x+e.Size.width-p,i.y+(e.Size.height-f)/2),e.x=g.x,e.y=g.y,e.BoundingRectangle=new o(e.x,e.y,e.width,e.height),l=g.x-this.options.horizontalSeparation,d=i.y,n=0;n<e.children.length;n++)s=e.children[n],r=new u(l-s.Size.width,d),this.arrange(s,r),d+=s.Size.height+this.options.verticalSeparation;break;default:throw"Unsupported TreeDirection"}break;case t.diagram.TreeDirection.Right:switch(e.childrenLayout){case t.diagram.ChildrenLayout.TopAlignedWithParent:break;case t.diagram.ChildrenLayout.BottomAlignedWithParent:break;case t.diagram.ChildrenLayout.Underneath:for(g=i,e.x=g.x,e.y=g.y,e.BoundingRectangle=new o(e.x,e.y,e.width,e.height),l=i.x+p+this.options.underneathHorizontalOffset,d=i.y+f+this.options.underneathVerticalTopOffset,n=0;n<e.children.length;n++)s=e.children[n],r=new u(l,d),this.arrange(s,r),d+=s.Size.height+this.options.underneathVerticalSeparation;break;case t.diagram.ChildrenLayout.Default:for(g=new u(i.x,i.y+(e.Size.height-f)/2),e.x=g.x,e.y=g.y,e.BoundingRectangle=new o(e.x,e.y,e.width,e.height),l=i.x+p+this.options.horizontalSeparation,d=i.y,n=0;n<e.children.length;n++)s=e.children[n],r=new u(l,d),this.arrange(s,r),d+=s.Size.height+this.options.verticalSeparation;break;default:throw"Unsupported TreeDirection"}break;case t.diagram.TreeDirection.Up:if(g=new u(i.x+(e.Size.width-p)/2,i.y+e.Size.height-f),e.x=g.x,e.y=g.y,e.BoundingRectangle=new o(e.x,e.y,e.width,e.height),Math.abs(g.x-i.x)<Math.epsilon){for(h=0,n=0;n<e.children.length;n++)a=e.children[n],h+=a.Size.width+this.options.horizontalSeparation;h-=this.options.horizontalSeparation,l=i.x+(p-h)/2}else l=i.x;for(n=0;n<e.children.length;n++)s=e.children[n],d=g.y-this.options.verticalSeparation-s.Size.height,r=new u(l,d),this.arrange(s,r),l+=s.Size.width+this.options.horizontalSeparation;break;case t.diagram.TreeDirection.Down:switch(e.childrenLayout){case t.diagram.ChildrenLayout.TopAlignedWithParent:break;case t.diagram.ChildrenLayout.BottomAlignedWithParent:break;case t.diagram.ChildrenLayout.Underneath:for(g=i,e.x=g.x,e.y=g.y,e.BoundingRectangle=new o(e.x,e.y,e.width,e.height),l=i.x+this.options.underneathHorizontalOffset,d=i.y+f+this.options.underneathVerticalTopOffset,n=0;n<e.children.length;n++)s=e.children[n],r=new u(l,d),this.arrange(s,r),d+=s.Size.height+this.options.underneathVerticalSeparation;break;case t.diagram.ChildrenLayout.Default:if(g=new u(i.x+(e.Size.width-p)/2,i.y),e.x=g.x,e.y=g.y,e.BoundingRectangle=new o(e.x,e.y,e.width,e.height),Math.abs(g.x-i.x)<Math.epsilon){for(h=0,n=0;n<e.children.length;n++)a=e.children[n],h+=a.Size.width+this.options.horizontalSeparation;h-=this.options.horizontalSeparation,l=i.x+(p-h)/2}else l=i.x;for(n=0;n<e.children.length;n++)s=e.children[n],d=g.y+this.options.verticalSeparation+f,r=new u(l,d),this.arrange(s,r),l+=s.Size.width+this.options.horizontalSeparation;break;default:throw"Unsupported TreeDirection"}break;case t.diagram.TreeDirection.None:break;default:throw"Unsupported TreeDirection"}},layoutSwitch:function(){var e,i,n,r,a,s;if(this.center&&!this.center.children.isEmpty())switch(e=this.options.TreeLayoutType,g.isUndefined(e)&&(e=t.diagram.TreeLayoutType.TreeDown),s=this.center.children,e){case t.diagram.TreeLayoutType.RadialTree:this.layoutRadialTree();break;case t.diagram.TreeLayoutType.MindmapHorizontal:i=this.center.children,1===this.center.children.length?this.layoutRight(i):(a=s.length/2,n=this.center.children.where(function(t){return s.indexOf(t)<a}),r=this.center.children.where(function(t){return s.indexOf(t)>=a}),this.layoutLeft(n),this.layoutRight(r));break;case t.diagram.TreeLayoutType.MindmapVertical:i=this.center.children,1===this.center.children.length?this.layoutDown(i):(a=s.length/2,n=this.center.children.where(function(t){return s.indexOf(t)<a}),r=this.center.children.where(function(t){return s.indexOf(t)>=a}),this.layoutUp(n),this.layoutDown(r));break;case t.diagram.TreeLayoutType.TreeRight:this.layoutRight(this.center.children);break;case t.diagram.TreeLayoutType.TreeLeft:this.layoutLeft(this.center.children);break;case t.diagram.TreeLayoutType.TreeUp:this.layoutUp(this.center.children);break;case t.diagram.TreeLayoutType.TreeDown:this.layoutDown(this.center.children);break;case t.diagram.TreeLayoutType.TipOverTree:if(this.options.tipOverTreeStartLevel<0)throw"The tip-over level should be a positive integer.";this.tipOverTree(this.center.children,this.options.tipOverTreeStartLevel);break;case t.diagram.TreeLayoutType.Undefined:}}}),m=c.extend({init:function(t){var e=this;if(c.fn.init.call(e),g.isUndefined(t))throw"No diagram specified.";this.diagram=t},layout:function(e){var i,n;return this.transferOptions(e),i=new p(this.diagram),this.graph=i.convert(),n=this.layoutComponents(),new t.diagram.LayoutState(this.diagram,n)},layoutComponents:function(){var t,e,i,n,r,a,s,o;if(!this.graph.isEmpty()&&(t=this.graph.getConnectedComponents(),!t.isEmpty())){for(e=new y(this.options),i=[],n=0;n<t.length;n++){if(r=t[n],a=this.getTree(r),!a)throw"Failed to find a spanning tree for the component.";s=a.root,o=a.tree,e.layout(o,s),i.push(o)}return this.gridLayoutComponents(i)}},getTree:function(t){var e,i,n,r,a,s=null;if(this.options.roots&&this.options.roots.length>0)for(e=0,i=t.nodes.length;i>e;e++)for(n=t.nodes[e],r=0;r<this.options.roots.length;r++)if(a=this.options.roots[r],a===n.associatedShape){s=n;break}if(!s&&(s=t.root(),!s))throw"Unable to find a root for the tree.";return this.getTreeForRoot(t,s)},getTreeForRoot:function(t,e){var i=t.getSpanningTree(e);return g.isUndefined(i)||i.isEmpty()?null:{tree:i,root:i.root}}}),w={TopAlignedWithParent:0,BottomAlignedWithParent:1,Underneath:2,Default:3},L={TreeLayout:0,LayeredLayout:1,ForceDirectedLayout:2,None:3},C={Left:0,Right:1,Up:2,Down:3,None:4,Radial:5,Undefined:6},v={MindmapHorizontal:0,MindmapVertical:1,TreeRight:2,TreeLeft:3,TreeUp:4,TreeDown:5,TipOverTree:6,RadialTree:7,Undefined:8},T={Up:0,Down:1,Left:2,Right:3},D=c.extend({init:function(t){var e=this;if(c.fn.init.call(e),g.isUndefined(t))throw"Diagram is not specified.";this.diagram=t},layout:function(e){var i,n,r,a,s,o;if(this.transferOptions(e),i=new p(this.diagram),n=i.convert(e),!n.isEmpty()&&(r=n.getConnectedComponents(),!r.isEmpty())){for(a=0;a<r.length;a++)s=r[a],this.layoutGraph(s,e);return o=this.gridLayoutComponents(r),new t.diagram.LayoutState(this.diagram,o)}},_initRuntimeProperties:function(){var t,e;for(t=0;t<this.graph.nodes.length;t++)e=this.graph.nodes[t],e.layer=-1,e.downstreamLinkCount=0,e.upstreamLinkCount=0,e.isVirtual=!1,e.uBaryCenter=0,e.dBaryCenter=0,e.upstreamPriority=0,e.downstreamPriority=0,e.gridPosition=0},_prepare:function(t){var e,i,n,r,a,s,o,l,d,g,u,c,p=[];for(i=0;i<t.links.length;i++)t.links[i].depthOfDumminess=0;for(r=new h,t.nodes.forEach(function(t){0===t.incoming.length&&(r.set(t,0),p.push(t))});p.length>0;)for(a=p.shift(),e=0;e<a.outgoing.length;e++)n=a.outgoing[e],s=n.target,r.containsKey(s)?r.set(s,Math.max(r.get(a)+1,r.get(s))):r.set(s,r.get(a)+1),p.contains(s)||p.push(s);for(o=0,r.forEachValue(function(t){o=Math.max(o,t)}),l=[],l.addRange(r.keys()),l.sort(function(t,e){var i=r.get(t),n=r.get(e);return Math.sign(n-i)}),d=0;d<l.length;++d)if(g=l[d],u=Number.MAX_VALUE,0!==g.outgoing.length){for(i=0;i<g.outgoing.length;++i)n=g.outgoing[i],u=Math.min(u,r.get(n.target));u>1&&r.set(g,u-1)}for(this.layers=[],e=0;o+1>e;e++)this.layers.push([]);for(r.forEach(function(t,e){t.layer=e,this.layers[e].push(t)},this),i=0;i<this.layers.length;i++)for(c=this.layers[i],e=0;e<c.length;e++)c[e].gridPosition=e},layoutGraph:function(t,e){if(g.isUndefined(t))throw"No graph given or graph analysis of the diagram failed.";g.isDefined(e)&&this.transferOptions(e),this.graph=t,t.setItemIndices();var i=t.makeAcyclic();this._initRuntimeProperties(),this._prepare(t,e),this._dummify(),this._optimizeCrossings(),this._swapPairs(),this.arrangeNodes(),this._moveThingsAround(),this._dedummify(),i.forEach(function(t){t.points&&t.points.reverse()})},setMinDist:function(t,e,i){var n=t.layer,r=t.layerIndex;this.minDistances[n][r]=i},getMinDist:function(t,e){var i,n=0,r=t.layerIndex,a=e.layerIndex,s=t.layer,o=Math.min(r,a),h=Math.max(r,a);for(i=o;h>i;++i)n+=this.minDistances[s][i];return n},placeLeftToRight:function(t){var e,i,n,r,a,s,o,l,d,g,u=new h;for(n=0;n<this.layers.length;++n)if(r=t[n]){for(e=0;e<r.length;e++)i=r[e],u.containsKey(i)||this.placeLeft(i,u,n);for(a=Number.POSITIVE_INFINITY,e=0;e<r.length;e++)i=r[e],s=this.rightSibling(i),s&&this.nodeLeftClass.get(s)!==n&&(a=Math.min(a,u.get(s)-u.get(i)-this.getMinDist(i,s)));if(a===Number.POSITIVE_INFINITY){for(o=[],e=0;e<r.length;e++)for(i=r[e],l=[],l.addRange(this.upNodes.get(i)),l.addRange(this.downNodes.get(i)),d=0;d<l.length;d++)g=l[d],this.nodeLeftClass.get(g)<n&&o.push(u.get(g)-u.get(i));o.sort(),a=0===o.length?0:1===o.length%2?o[this.intDiv(o.length,2)]:(o[this.intDiv(o.length,2)-1]+o[this.intDiv(o.length,2)])/2}for(e=0;e<r.length;e++)i=r[e],u.set(i,u.get(i)+a)}return u},placeRightToLeft:function(t){var e,i,n,r,a,s,o,l,d,g,u=new h;for(n=0;n<this.layers.length;++n)if(r=t[n]){for(e=0;e<r.length;e++)i=r[e],u.containsKey(i)||this.placeRight(i,u,n);for(a=Number.NEGATIVE_INFINITY,e=0;e<r.length;e++)i=r[e],s=this.leftSibling(i),s&&this.nodeRightClass.get(s)!==n&&(a=Math.max(a,u.get(s)-u.get(i)+this.getMinDist(s,i)));if(a===Number.NEGATIVE_INFINITY){for(o=[],e=0;e<r.length;e++)for(i=r[e],l=[],l.addRange(this.upNodes.get(i)),l.addRange(this.downNodes.get(i)),d=0;d<l.length;d++)g=l[d],this.nodeRightClass.get(g)<n&&o.push(u.get(i)-u.get(g));o.sort(),a=0===o.length?0:1===o.length%2?o[this.intDiv(o.length,2)]:(o[this.intDiv(o.length,2)-1]+o[this.intDiv(o.length,2)])/2}for(e=0;e<r.length;e++)i=r[e],u.set(i,u.get(i)+a)}return u},_getLeftWing:function(){var t={value:null},e=this.computeClasses(t,1);return this.nodeLeftClass=t.value,e},_getRightWing:function(){var t={value:null},e=this.computeClasses(t,-1);return this.nodeRightClass=t.value,e},computeClasses:function(t,e){var i,n,r,a,s,o,l,d,g,u=0,c=t.value=new h;for(i=0;i<this.layers.length;++i)for(u=i,n=this.layers[i],r=1===e?0:n.length-1;r>=0&&r<n.length;r+=e)if(a=n[r],c.containsKey(a))u=c.get(a);else if(c.set(a,u),a.isVirtual)for(s=this._nodesInLink(a),o=0;o<s.length;o++)l=s[o],c.set(l,u);for(d=[],g=0;g<this.layers.length;g++)d.push(null);return c.forEach(function(t,e){null===d[e]&&(d[e]=[]),d[e].push(t)}),d},_isVerticalLayout:function(){return this.options.layeredLayoutType===t.diagram.LayeredLayoutType.Up||this.options.layeredLayoutType===t.diagram.LayeredLayoutType.Down},_isHorizontalLayout:function(){return this.options.layeredLayoutType===t.diagram.LayeredLayoutType.Right||this.options.layeredLayoutType===t.diagram.LayeredLayoutType.Left},_isIncreasingLayout:function(){return this.options.layeredLayoutType===t.diagram.LayeredLayoutType.Right||this.options.layeredLayoutType===t.diagram.LayeredLayoutType.Down},_moveThingsAround:function(){function t(t,e){var i,n,r=Number.MIN_VALUE;for(i=0;i<t.length;++i)n=t[i],r=e._isVerticalLayout()?Math.max(r,n.height):Math.max(r,n.width);return r}var e,i,n,r,a,s,o,l,d,g,u,c,p,f,y,m,w,L,C,v,T,D,x,M,S,k,b;for(i=0;i<this.layers.length;++i)r=this.layers[i],r.sort(this._gridPositionComparer);for(this.minDistances=[],i=0;i<this.layers.length;++i)for(r=this.layers[i],this.minDistances[i]=[],a=0;a<r.length;++a)n=r[a],n.layerIndex=a,this.minDistances[i][a]=this.options.nodeDistance,a<r.length-1&&(this.minDistances[i][a]+=this._isVerticalLayout()?(n.width+r[a+1].width)/2:(n.height+r[a+1].height)/2);for(this.downNodes=new h,this.upNodes=new h,this.graph.nodes.forEach(function(t){this.downNodes.set(t,[]),this.upNodes.set(t,[])},this),this.graph.links.forEach(function(t){var e=t.source,i=t.target,n=null,r=null;e.layer>i.layer?(n=t.source,r=t.target):(r=t.source,n=t.target),this.downNodes.get(r).push(n),this.upNodes.get(n).push(r)
},this),this.downNodes.forEachValue(function(t){t.sort(this._gridPositionComparer)}),this.upNodes.forEachValue(function(t){t.sort(this._gridPositionComparer)}),i=0;i<this.layers.length-1;++i)for(r=this.layers[i],s=0;s<r.length-1;s++)if(o=r[s],o.isVirtual&&(l=this.downNodes.get(o)[0],l.isVirtual))for(a=s+1;a<r.length;++a)n=r[a],n.isVirtual&&(d=this.downNodes.get(n)[0],d.isVirtual&&l.gridPosition>d.gridPosition&&(g=l.gridPosition,l.gridPosition=d.gridPosition,d.gridPosition=g,u=l.layerIndex,c=d.layerIndex,this.layers[i+1][u]=d,this.layers[i+1][c]=l,l.layerIndex=c,d.layerIndex=u));for(p=this._getLeftWing(),f=this._getRightWing(),y=this.placeLeftToRight(p),m=this.placeRightToLeft(f),w=new h,this.graph.nodes.forEach(function(t){w.set(t,(y.get(t)+m.get(t))/2)}),L=new h,C=new h,i=0;i<this.layers.length;++i)for(r=this.layers[i],v=-1,T=-1,a=0;a<r.length;++a)n=r[a],L.set(n,0),C.set(n,!1),n.isVirtual&&(-1===v?v=a:v===a-1?v=a:(T=a,L.set(r[v],0),w.get(n)-w.get(r[v])===this.getMinDist(r[v],n)?C.set(r[v],!0):C.set(r[v],!1),v=a));for(D=[1,-1],D.forEach(function(t){var i,n,r,a,s,o,h,l=1===t?0:this.layers.length-1;for(i=l;i>=0&&i<this.layers.length;i+=t){if(n=this.layers[i],r=this._firstVirtualNode(n),a=null,s=null,-1!==r)for(a=n[r],s=[],e=0;r>e;e++)s.push(n[e]);else a=null,s=n;if(s.length>0){for(this._sequencer(w,null,a,t,s),e=0;e<s.length-1;++e)this.setMinDist(s[e],s[e+1],w.get(s[e+1])-w.get(s[e]));a&&this.setMinDist(s[s.length-1],a,w.get(a)-w.get(s[s.length-1]))}for(;a;){if(o=this.nextVirtualNode(n,a)){if(L.get(a)===t){for(r=a.layerIndex,h=o.layerIndex,s=[],e=r+1;h>e;e++)s.push(n[e]);s.length>0&&this._sequencer(w,a,o,t,s),C.set(a,!0)}}else{for(r=a.layerIndex,s=[],e=r+1;e<n.length;e++)s.push(n[e]);if(s.length>0){for(this._sequencer(w,a,null,t,s),e=0;e<s.length-1;++e)this.setMinDist(s[e],s[e+1],w.get(s[e+1])-w.get(s[e]));this.setMinDist(a,s[0],w.get(s[0])-w.get(a))}}a=o}this.adjustDirections(i,t,L,C)}},this),x=this._isIncreasingLayout()?0:this.layers.length-1,M=function(t,e){return e._isIncreasingLayout()?t<e.layers.length:t>=0},S=this._isIncreasingLayout()?1:-1,k=0,e=x;M(e,this);e+=S){for(r=this.layers[e],b=t(r,this),a=0;a<r.length;++a)n=r[a],this._isVerticalLayout()?(n.x=w.get(n),n.y=k+b/2):(n.x=k+b/2,n.y=w.get(n));k+=this.options.layerSeparation+b}},adjustDirections:function(t,e,i,n){var r,a,s,o,h,l,d,g,u,c,p,f,y,m;if(!(0>t+e||t+e>=this.layers.length))for(r=null,a=null,s=this.layers[t+e],o=0;o<s.length;++o)if(h=s[o],h.isVirtual&&(l=this.getNeighborOnLayer(h,t),l.isVirtual)){if(r){for(d=n.get(a),g=this.layers[t],u=a.layerIndex,c=l.layerIndex,p=u+1;c>p;++p)g[p].isVirtual&&(d=d&&n.get(g[p]));if(d)for(i.set(r,e),f=r.layerIndex,y=h.layerIndex,m=f+1;y>m;++m)s[m].isVirtual&&i.set(s[m],e)}r=h,a=l}},getNeighborOnLayer:function(t,e){var i=this.upNodes.get(t)[0];return i.layer===e?i:(i=this.downNodes.get(t)[0],i.layer===e?i:null)},_sequencer:function(t,e,i,n,r){if(1===r.length&&this._sequenceSingle(t,e,i,n,r[0]),r.length>1){var a=r.length,s=this.intDiv(a,2);this._sequencer(t,e,i,n,r.slice(0,s)),this._sequencer(t,e,i,n,r.slice(s)),this.combineSequences(t,e,i,n,r)}},_sequenceSingle:function(t,e,i,n,r){var a=-1===n?this.downNodes.get(r):this.upNodes.get(r),s=a.length;0!==s&&(1===s%2?t.set(r,t.get(a[this.intDiv(s,2)])):t.set(r,(t.get(a[this.intDiv(s,2)-1])+t.get(a[this.intDiv(s,2)]))/2),e&&t.set(r,Math.max(t.get(r),t.get(e)+this.getMinDist(e,r))),i&&t.set(r,Math.min(t.get(r),t.get(i)-this.getMinDist(r,i))))},combineSequences:function(t,e,i,n,r){var a,s,o,h,l,d,g,u,c,p,f=r.length,y=this.intDiv(f,2),m=[];for(a=0;y>a;++a){for(s=0,h=-1===n?this.downNodes.get(r[a]):this.upNodes.get(r[a]),o=0;o<h.length;++o)l=h[o],t.get(l)>=t.get(r[a])?s++:(s--,m.push({k:t.get(l)+this.getMinDist(r[a],r[y-1]),v:2}));m.push({k:t.get(r[a])+this.getMinDist(r[a],r[y-1]),v:s})}for(e&&m.push({k:t.get(e)+this.getMinDist(e,r[y-1]),v:Number.MAX_VALUE}),m.sort(this._positionDescendingComparer),g=[],a=y;f>a;++a){for(s=0,h=-1===n?this.downNodes.get(r[a]):this.upNodes.get(r[a]),o=0;o<h.length;++o)l=h[o],t.get(l)<=t.get(r[a])?s++:(s--,g.push({k:t.get(l)-this.getMinDist(r[a],r[y]),v:2}));g.push({k:t.get(r[a])-this.getMinDist(r[a],r[y]),v:s})}for(i&&g.push({k:t.get(i)-this.getMinDist(i,r[y]),v:Number.MAX_VALUE}),g.sort(this._positionAscendingComparer),u=0,c=0,p=this.getMinDist(r[y-1],r[y]);t.get(r[y])-t.get(r[y-1])<p;)if(c>u){if(0===m.length){t.set(r[y-1],t.get(r[y])-p);break}d=m.shift(),u+=d.v,t.set(r[y-1],d.k),t.set(r[y-1],Math.max(t.get(r[y-1]),t.get(r[y])-p))}else{if(0===g.length){t.set(r[y],t.get(r[y-1])+p);break}d=g.shift(),c+=d.v,t.set(r[y],d.k),t.set(r[y],Math.min(t.get(r[y]),t.get(r[y-1])+p))}for(a=y-2;a>=0;a--)t.set(r[a],Math.min(t.get(r[a]),t.get(r[y-1])-this.getMinDist(r[a],r[y-1])));for(a=y+1;f>a;a++)t.set(r[a],Math.max(t.get(r[a]),t.get(r[y])+this.getMinDist(r[a],r[y])))},placeLeft:function(t,e,i){var n=Number.NEGATIVE_INFINITY;this._getComposite(t).forEach(function(t){var r=this.leftSibling(t);r&&this.nodeLeftClass.get(r)===this.nodeLeftClass.get(t)&&(e.containsKey(r)||this.placeLeft(r,e,i),n=Math.max(n,e.get(r)+this.getMinDist(r,t)))},this),n===Number.NEGATIVE_INFINITY&&(n=0),this._getComposite(t).forEach(function(t){e.set(t,n)})},placeRight:function(t,e,i){var n=Number.POSITIVE_INFINITY;this._getComposite(t).forEach(function(t){var r=this.rightSibling(t);r&&this.nodeRightClass.get(r)===this.nodeRightClass.get(t)&&(e.containsKey(r)||this.placeRight(r,e,i),n=Math.min(n,e.get(r)-this.getMinDist(t,r)))},this),n===Number.POSITIVE_INFINITY&&(n=0),this._getComposite(t).forEach(function(t){e.set(t,n)})},leftSibling:function(t){var e=this.layers[t.layer],i=t.layerIndex;return 0===i?null:e[i-1]},rightSibling:function(t){var e=this.layers[t.layer],i=t.layerIndex;return i===e.length-1?null:e[i+1]},_getComposite:function(t){return t.isVirtual?this._nodesInLink(t):[t]},arrangeNodes:function(){var t,e,i,n,r,a,s,o;for(e=0;e<this.layers.length;e++)for(n=this.layers[e],i=0;i<n.length;i++)r=n[i],r.upstreamPriority=r.upstreamLinkCount,r.downstreamPriority=r.downstreamLinkCount;for(a=2,s=0;a>s;s++){for(t=this.layers.length-1;t>=1;t--)this.layoutLayer(!1,t);for(t=0;t<this.layers.length-1;t++)this.layoutLayer(!0,t)}for(o=Number.MAX_VALUE,e=0;e<this.layers.length;e++)for(n=this.layers[e],i=0;i<n.length;i++)r=n[i],o=Math.min(o,r.gridPosition);if(0>o)for(e=0;e<this.layers.length;e++)for(n=this.layers[e],i=0;i<n.length;i++)r=n[i],r.gridPosition=r.gridPosition-o},layoutLayer:function(t,e){var i,n,r,a;for(n=t?this.layers[i=e+1]:this.layers[i=e-1],r=[],a=0;a<n.length;a++)r.push(n[a]);r.sort(function(t,e){var i=(t.upstreamPriority+t.downstreamPriority)/2,n=(e.upstreamPriority+e.downstreamPriority)/2;return Math.abs(i-n)<1e-4?0:n>i?1:-1}),r.forEach(function(t){var e=t.gridPosition,i=this.calcBaryCenter(t),r=(t.upstreamPriority+t.downstreamPriority)/2;if(!(Math.abs(e-i)<1e-4||Math.abs(e-i)<.2501))if(i>e)for(;i>e&&this.moveRight(t,n,r);)e=t.gridPosition;else for(;e>i&&this.moveLeft(t,n,r);)e=t.gridPosition},this),i>0&&this.calcDownData(i-1),i<this.layers.length-1&&this.calcUpData(i+1)},moveRight:function(t,e,i){var n,r,a=e.indexOf(t);return a===e.length-1?(t.gridPosition=t.gridPosition+.5,!0):(n=e[a+1],r=(n.upstreamPriority+n.downstreamPriority)/2,n.gridPosition>t.gridPosition+1?(t.gridPosition=t.gridPosition+.5,!0):r>i||Math.abs(r-i)<1e-4?!1:this.moveRight(n,e,i)?(t.gridPosition=t.gridPosition+.5,!0):!1)},moveLeft:function(t,e,i){var n,r,a=e.indexOf(t);return 0===a?(t.gridPosition=t.gridPosition-.5,!0):(n=e[a-1],r=(n.upstreamPriority+n.downstreamPriority)/2,n.gridPosition<t.gridPosition-1?(t.gridPosition=t.gridPosition-.5,!0):r>i||Math.abs(r-i)<1e-4?!1:this.moveLeft(n,e,i)?(t.gridPosition=t.gridPosition-.5,!0):!1)},mapVirtualNode:function(t,e){this.nodeToLinkMap.set(t,e),this.linkToNodeMap.containsKey(e)||this.linkToNodeMap.set(e,[]),this.linkToNodeMap.get(e).push(t)},_nodesInLink:function(t){return this.linkToNodeMap.get(this.nodeToLinkMap.get(t))},_dummify:function(){var t,e,i,a,s,o,l,d,g,u,c,p,f,y,m,w,L,C;for(this.linkToNodeMap=new h,this.nodeToLinkMap=new h,g=this.graph.links.slice(0),d=0;d<g.length;d++){if(u=g[d],c=u.source,p=u.target,f=c.layer,y=p.layer,m=c.gridPosition,w=p.gridPosition,L=(w-m)/Math.abs(y-f),C=c,f-y>1){for(l=f-1;l>y;l--){for(i=new n,i.x=c.x,i.y=c.y,i.width=c.width/100,i.height=c.height/100,t=this.layers[l],e=(l-y)*L+m,e>t.length&&(e=t.length),m>=this.layers[f].length-1&&w>=this.layers[y].length-1?e=t.length:0===m&&0===w&&(e=0),i.layer=l,i.uBaryCenter=0,i.dBaryCenter=0,i.upstreamLinkCount=0,i.downstreamLinkCount=0,i.gridPosition=e,i.isVirtual=!0,t.insert(i,e),s=e+1;s<t.length;s++)a=t[s],a.gridPosition=a.gridPosition+1;o=new r(C,i),o.depthOfDumminess=0,C=i,this.graph.nodes.push(i),this.graph.addLink(o),i.index=this.graph.nodes.length-1,this.mapVirtualNode(i,u)}u.changeSource(C),u.depthOfDumminess=f-y-1}if(-1>f-y){for(l=f+1;y>l;l++){for(i=new n,i.x=c.x,i.y=c.y,i.width=c.width/100,i.height=c.height/100,t=this.layers[l],e=(l-f)*L+m,e>t.length&&(e=t.length),m>=this.layers[f].length-1&&w>=this.layers[y].length-1?e=t.length:0===m&&0===w&&(e=0),i.layer=l,i.uBaryCenter=0,i.dBaryCenter=0,i.upstreamLinkCount=0,i.downstreamLinkCount=0,i.gridPosition=e,i.isVirtual=!0,e&=e,t.insert(i,e),s=e+1;s<t.length;s++)a=t[s],a.gridPosition=a.gridPosition+1;o=new r(C,i),o.depthOfDumminess=0,C=i,this.graph.nodes.push(i),this.graph.addLink(o),i.index=this.graph.nodes.length-1,this.mapVirtualNode(i,u)}u.changeSource(C),u.depthOfDumminess=y-f-1}}},_dedummify:function(){for(var t,e,i,n,r,a,s,o,h=!0;h;)for(h=!1,t=0;t<this.graph.links.length;t++)if(e=this.graph.links[t],0!==e.depthOfDumminess){for(i=[],i.prepend({x:e.target.x,y:e.target.y}),i.prepend({x:e.source.x,y:e.source.y}),n=e,r=e.depthOfDumminess,a=0;r>a;a++)s=n.source,o=s.incoming[0],i.prepend({x:o.source.x,y:o.source.y}),n=o;e.changeSource(n.source),e.depthOfDumminess=0,i.length>2?(i.splice(0,1),i.splice(i.length-1),e.points=i):e.points=[],h=!0;break}},_optimizeCrossings:function(){for(var t,e=-1,i=3,n=0;0!==e&&!(n++>i);){for(e=0,t=this.layers.length-1;t>=1;t--)e+=this.optimizeLayerCrossings(!1,t);for(t=0;t<this.layers.length-1;t++)e+=this.optimizeLayerCrossings(!0,t)}},calcUpData:function(t){var e,i,n,r,a,s,o,h,d;if(0!==t){for(r=this.layers[t],a=new l,s=this.layers[t-1],e=0;e<s.length;e++)a.add(s[e]);for(e=0;e<r.length;e++){for(o=r[e],h=0,d=0,i=0;i<o.incoming.length;i++)n=o.incoming[i],a.contains(n.source)&&(d++,h+=n.source.gridPosition);for(i=0;i<o.outgoing.length;i++)n=o.outgoing[i],a.contains(n.target)&&(d++,h+=n.target.gridPosition);d>0?(o.uBaryCenter=h/d,o.upstreamLinkCount=d):(o.uBaryCenter=e,o.upstreamLinkCount=0)}}},calcDownData:function(t){var e,i,n,r,a,s,o,h,d;if(t!==this.layers.length-1){for(r=this.layers[t],a=new l,s=this.layers[t+1],e=0;e<s.length;e++)a.add(s[e]);for(e=0;e<r.length;e++){for(o=r[e],h=0,d=0,i=0;i<o.incoming.length;i++)n=o.incoming[i],a.contains(n.source)&&(d++,h+=n.source.gridPosition);for(i=0;i<o.outgoing.length;i++)n=o.outgoing[i],a.contains(n.target)&&(d++,h+=n.target.gridPosition);d>0?(o.dBaryCenter=h/d,o.downstreamLinkCount=d):(o.dBaryCenter=e,o.downstreamLinkCount=0)}}},optimizeLayerCrossings:function(t,e){var i,n,r,a,s,o,h;for(n=t?this.layers[i=e+1]:this.layers[i=e-1],r=n.slice(0),t?this.calcUpData(i):this.calcDownData(i),Array.prototype.sort.call(this,n,function(t,e){var i,n=this.calcBaryCenter(t),r=this.calcBaryCenter(e);return Math.abs(n-r)<1e-4?t.degree()===e.degree()?this.compareByIndex(t,e):t.degree()<e.degree()?1:-1:(i=1e3*(r-n),i>0?-1:0>i?1:this.compareByIndex(t,e))}),s=0,a=0;a<n.length;a++)n[a]!==r[a]&&s++;if(s>0)for(o=0,a=0;a<n.length;a++)h=n[a],h.gridPosition=o++;return s},_swapPairs:function(){for(var t,e,i,n,r,a,s,o,h,l,d,g,u,c,p,f,y,m=this.options.layeredIterations,w=0;;){if(w++>m)break;for(t=1>=w%4,e=1===w%4,i=t?0:this.layers.length-1;t?i<=this.layers.length-1:i>=0;i+=t?1:-1){for(n=this.layers[i],r=!1,a=!0,s=0,o=0;o<n.length-1;o++)h=0,l=0,d=0,a?(0!==i&&(h=this.countLinksCrossingBetweenTwoLayers(i-1,i)),i!==this.layers.length-1&&(l=this.countLinksCrossingBetweenTwoLayers(i,i+1)),t?h*=2:l*=2,d=h+l):d=s,0!==d&&(g=n[o],u=n[o+1],c=g.gridPosition,p=u.gridPosition,n[o]=u,n[o+1]=g,g.gridPosition=p,u.gridPosition=c,h=0,0!==i&&(h=this.countLinksCrossingBetweenTwoLayers(i-1,i)),l=0,i!==this.layers.length-1&&(l=this.countLinksCrossingBetweenTwoLayers(i,i+1)),t?h*=2:l*=2,f=h+l,y=!1,y=e?f>=d:f>d,y?(g=n[o],u=n[o+1],c=g.gridPosition,p=u.gridPosition,n[o]=u,n[o+1]=g,g.gridPosition=p,u.gridPosition=c,s=d,a=!1):(r=!0,a=!0));r&&(i!==this.layers.length-1&&this.calcUpData(i+1),0!==i&&this.calcDownData(i-1))}}},countLinksCrossingBetweenTwoLayers:function(t,e){var i,n,r,a,s,o,h,d,g,u,c,p,f,y,m,w,L,C,v,T,D=0,x=new l,M=this.layers[t];for(i=0;i<M.length;i++)x.add(M[i]);for(n=new l,r=this.layers[e],i=0;i<r.length;i++)n.add(r[i]);for(a=new l,s=[],o=[],x.forEach(function(t){o.addRange(t.incoming),o.addRange(t.outgoing)}),h=0;h<o.length;h++)d=o[h],x.contains(d.source)&&n.contains(d.target)?(a.add(d),s.push(d)):n.contains(d.source)&&x.contains(d.target)&&s.push(d);for(g=0;g<s.length;g++)for(u=s[g],c=0;c<s.length;c++)g!==c&&(p=s[c],a.contains(u)?(f=u.source,y=u.target):(f=u.target,y=u.source),a.contains(p)?(m=p.source,w=p.target):(m=p.target,w=p.source),L=f.gridPosition,C=y.gridPosition,v=m.gridPosition,T=w.gridPosition,0>(L-v)*(C-T)&&D++);return D/2},calcBaryCenter:function(t){var e=t.upstreamLinkCount,i=t.downstreamLinkCount,n=t.uBaryCenter,r=t.dBaryCenter;return e>0&&i>0?(n+r)/2:e>0?n:i>0?r:0},_gridPositionComparer:function(t,e){return t.gridPosition<e.gridPosition?-1:t.gridPosition>e.gridPosition?1:0},_positionAscendingComparer:function(t,e){return t.k<e.k?-1:t.k>e.k?1:0},_positionDescendingComparer:function(t,e){return t.k<e.k?1:t.k>e.k?-1:0},_firstVirtualNode:function(t){for(var e=0;e<t.length;e++)if(t[e].isVirtual)return e;return-1},compareByIndex:function(t,e){var i=t.index,n=e.index;return n>i?1:i>n?-1:0},intDiv:function(t,e){return(t-t%e)/e},nextVirtualNode:function(t,e){var i,n=e.layerIndex;for(i=n+1;i<t.length;++i)if(t[i].isVirtual)return t[i];return null}}),x=t.Class.extend({init:function(t,e){if(g.isUndefined(t))throw"No diagram given";this.diagram=t,this.nodeMap=new h,this.linkMap=new h,this.capture(e?e:t)},capture:function(e){var i,n,r,a,s,h,l,d,g;if(e instanceof t.diagram.Graph){for(a=0;a<e.nodes.length;a++)i=e.nodes[a],r=i.associatedShape,this.nodeMap.set(r.visual.native.id,new o(i.x,i.y,i.width,i.height));for(a=0;a<e.links.length;a++)h=e.links[a],s=h.associatedConnection,this.linkMap.set(s.visual.native.id,h.points())}else if(e instanceof Array)for(n=e,a=0;a<n.length;a++)i=n[a],r=i.associatedShape,r&&this.nodeMap.set(r.visual.native.id,new o(i.x,i.y,i.width,i.height));else if(e.hasOwnProperty("links")&&e.hasOwnProperty("nodes")){for(n=e.nodes,l=e.links,a=0;a<n.length;a++)i=n[a],r=i.associatedShape,r&&this.nodeMap.set(r.visual.native.id,new o(i.x,i.y,i.width,i.height));for(a=0;a<l.length;a++)h=l[a],s=h.associatedConnection,s&&this.linkMap.set(s.visual.native.id,h.points)}else{for(d=this.diagram.shapes,g=this.diagram.connections,a=0;a<d.length;a++)r=d[a],this.nodeMap.set(r.visual.native.id,r.bounds());for(a=0;a<g.length;a++)s=g[a],this.linkMap.set(s.visual.native.id,s.points())}}}),M=t.Class.extend({init:function(t){this.layoutState=t,this.diagram=t.diagram},initState:function(){function t(t,e){var i=this.diagram.getId(t);i&&(this.subjects.push(i),this.froms.push(i.bounds().topLeft()),this.tos.push(e.topLeft()))}this.froms=[],this.tos=[],this.subjects=[],this.layoutState.nodeMap.forEach(t,this)},update:function(t){if(!(this.subjects.length<=0))for(var e=0;e<this.subjects.length;e++)this.subjects[e].position(new u(this.froms[e].x+(this.tos[e].x-this.froms[e].x)*t,this.froms[e].y+(this.tos[e].y-this.froms[e].y)*t))}});a(e,{init:function(e){t.init(e,t.diagram.ui)},SpringLayout:f,TreeLayout:m,GraphAdapter:p,ChildrenLayout:w,LayoutTypes:L,TreeLayoutType:v,TreeDirection:C,LayeredLayout:D,LayeredLayoutType:T,LayoutBase:c,LayoutState:x,PositionAdapter:M})}(window.kendo.jQuery)})}("function"==typeof define&&define.amd?define:function(t,e){return e()});